<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>価格比較ツール</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .grid {
      display: grid;
      gap: 1rem;
    }

    .grid-cols-2 {
      grid-template-columns: 1fr 1fr;
    }

    .grid-cols-3 {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .input-field {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    .input-field:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: background-color 0.2s;
      min-height: 44px;
    }

    .btn-primary {
      background-color: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background-color: #2563eb;
    }

    .btn-danger {
      background-color: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background-color: #dc2626;
    }

    .btn-ghost {
      background-color: transparent;
      color: #ef4444;
      padding: 0.5rem;
    }

    .btn-ghost:hover {
      background-color: #fee2e2;
    }

    .current-product {
      background-color: #f0fdf4;
      border: 2px solid #bbf7d0;
    }

    .comparison-result {
      text-align: center;
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .comparison-good {
      background-color: #f0fdf4;
      border: 2px solid #16a34a;
    }

    .comparison-bad {
      background-color: #fef2f2;
      border: 2px solid #dc2626;
    }

    .regular-prices {
      background-color: #f8fafc;
    }

    .title {
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 2rem;
      color: #1e293b;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .unit-price {
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      padding: 1rem;
      background-color: #f8fafc;
      border-radius: 6px;
      color: #475569;
    }

    .text-green {
      color: #16a34a;
    }

    .text-red {
      color: #dc2626;
    }

    .text-blue {
      color: #2563eb;
    }

    .text-lg {
      font-size: 1.125rem;
    }

    .text-xl {
      font-size: 1.25rem;
    }

    .text-2xl {
      font-size: 1.5rem;
    }

    .text-3xl {
      font-size: 1.875rem;
    }

    .font-bold {
      font-weight: bold;
    }

    .font-semibold {
      font-weight: 600;
    }

    .mb-2 {
      margin-bottom: 0.5rem;
    }

    .mb-4 {
      margin-bottom: 1rem;
    }

    .mb-8 {
      margin-bottom: 2rem;
    }

    .mt-1 {
      margin-top: 0.25rem;
    }

    .mt-2 {
      margin-top: 0.5rem;
    }

    .space-y-4 > * + * {
      margin-top: 1rem;
    }

    .help-text {
      text-align: center;
      color: #64748b;
      padding: 2rem;
      background-color: #f8fafc;
      border-radius: 8px;
      margin-top: 2rem;
    }

    /* モバイル対応 */
    @media (max-width: 768px) {
      .container {
        padding: 0.5rem;
      }
      
      .grid-cols-2 {
        grid-template-columns: 1fr;
      }
      
      .grid-cols-3 {
        grid-template-columns: 1fr;
      }
      
      .title {
        font-size: 1.5rem;
      }
      
      .section-title {
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { 
      ShoppingCart, 
      Store, 
      Target, 
      Plus, 
      Trash2 
    } = lucide;

    // LocalStorageキー
    const STORAGE_KEY = 'priceComparison_regularPrices';

    const PriceComparisonTool = () => {
      const [regularPrices, setRegularPrices] = useState([]);
      const [currentProduct, setCurrentProduct] = useState({
        type: 'wrap',
        name: '',
        quantity: '',
        count: 1,
        price: '',
        unitPrice: 0
      });

      // データの読み込み
      useEffect(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            setRegularPrices(JSON.parse(saved));
          } catch (e) {
            console.error('データの読み込みに失敗:', e);
          }
        }
      }, []);

      // データの保存
      useEffect(() => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(regularPrices));
      }, [regularPrices]);

      // 商品タイプ定義
      const productTypes = [
        { value: 'wrap', label: 'ラップ', unit: 'm' },
        { value: 'toilet_paper', label: 'トイレットペーパー', unit: 'ロール' },
        { value: 'tissue', label: 'ティッシュペーパー', unit: '箱' },
        { value: 'detergent', label: '洗剤', unit: 'ml' },
        { value: 'shampoo', label: 'シャンプー', unit: 'ml' },
        { value: 'rice', label: 'お米', unit: 'kg' },
        { value: 'oil', label: '食用油', unit: 'ml' },
        { value: 'milk', label: '牛乳', unit: 'ml' },
        { value: 'bread', label: 'パン', unit: '枚' },
        { value: 'eggs', label: '卵', unit: '個' }
      ];

      const addRegularPrice = () => {
        const newPrice = {
          id: Date.now(),
          type: 'wrap',
          name: '',
          store: '',
          quantity: '',
          count: 1,
          price: '',
          unitPrice: 0,
          createdAt: new Date().toISOString()
        };
        setRegularPrices([...regularPrices, newPrice]);
      };

      const updateRegularPrice = (id, field, value) => {
        setRegularPrices(regularPrices.map(product => {
          if (product.id === id) {
            const updated = { ...product, [field]: value, updatedAt: new Date().toISOString() };
            
            // 単価計算
            if (field === 'quantity' || field === 'count' || field === 'price') {
              const quantity = parseFloat(updated.quantity) || 0;
              const count = parseFloat(updated.count) || 1;
              const price = parseFloat(updated.price) || 0;
              
              if (quantity > 0 && price > 0) {
                // 小数点計算の精度問題を回避
                updated.unitPrice = Math.round((price / (quantity * count)) * 100) / 100;
              } else {
                updated.unitPrice = 0;
              }
            }
            
            return updated;
          }
          return product;
        }));
      };

      const updateCurrentProduct = (field, value) => {
        const updated = { ...currentProduct, [field]: value };
        
        // 単価計算
        if (field === 'quantity' || field === 'count' || field === 'price') {
          const quantity = parseFloat(updated.quantity) || 0;
          const count = parseFloat(updated.count) || 1;
          const price = parseFloat(updated.price) || 0;
          
          if (quantity > 0 && price > 0) {
            // 小数点計算の精度問題を回避
            updated.unitPrice = Math.round((price / (quantity * count)) * 100) / 100;
          } else {
            updated.unitPrice = 0;
          }
        }
        
        setCurrentProduct(updated);
      };

      const removeRegularPrice = (id) => {
        setRegularPrices(regularPrices.filter(product => product.id !== id));
      };

      const getProductTypeInfo = (type) => {
        return productTypes.find(pt => pt.value === type) || productTypes[0];
      };

      const getComparison = () => {
        if (currentProduct.unitPrice === 0) return null;
        
        const sameTypeProducts = regularPrices.filter(p => 
          p.type === currentProduct.type && p.unitPrice > 0
        );
        
        if (sameTypeProducts.length === 0) return null;
        
        const cheapestRegular = sameTypeProducts.reduce((cheapest, current) => 
          current.unitPrice < cheapest.unitPrice ? current : cheapest
        );
        
        const savings = cheapestRegular.unitPrice - currentProduct.unitPrice;
        const savingsPercent = Math.abs((savings / cheapestRegular.unitPrice) * 100);
        
        return {
          cheapestRegular,
          savings,
          savingsPercent,
          isCurrentCheaper: savings > 0
        };
      };

      const comparison = getComparison();
      const currentTypeInfo = getProductTypeInfo(currentProduct.type);

      return (
        <div className="container">
          <h1 className="title">
            <ShoppingCart style={{ display: 'inline', marginRight: '0.5rem', color: '#3b82f6' }} />
            価格比較ツール
          </h1>

          {/* 今目の前の商品 */}
          <div className="card current-product">
            <h2 className="section-title text-green">
              <Target size={24} />
              今目の前の商品
            </h2>
            
            <div className="space-y-4">
              <div className="grid grid-cols-2">
                <select
                  value={currentProduct.type}
                  onChange={(e) => updateCurrentProduct('type', e.target.value)}
                  className="input-field"
                >
                  {productTypes.map(type => (
                    <option key={type.value} value={type.value}>{type.label}</option>
                  ))}
                </select>
                
                <input
                  type="text"
                  value={currentProduct.name}
                  onChange={(e) => updateCurrentProduct('name', e.target.value)}
                  placeholder="商品名（任意）"
                  className="input-field"
                />
              </div>
              
              <div className="grid grid-cols-3">
                <input
                  type="number"
                  value={currentProduct.quantity}
                  onChange={(e) => updateCurrentProduct('quantity', e.target.value)}
                  placeholder={`${currentTypeInfo.unit}数`}
                  className="input-field"
                  inputMode="decimal"
                />
                <input
                  type="number"
                  value={currentProduct.count}
                  onChange={(e) => updateCurrentProduct('count', e.target.value)}
                  placeholder="個数"
                  className="input-field"
                  inputMode="decimal"
                />
                <input
                  type="number"
                  value={currentProduct.price}
                  onChange={(e) => updateCurrentProduct('price', e.target.value)}
                  placeholder="価格 (円)"
                  className="input-field font-bold"
                  inputMode="decimal"
                  autoFocus
                />
              </div>
              
              <div className="unit-price">
                単価: {currentProduct.unitPrice > 0 ? `${currentProduct.unitPrice.toFixed(2)}円/${currentTypeInfo.unit}` : '-'}
                {currentProduct.name && (
                  <div className="text-lg mt-1" style={{ color: '#64748b' }}>
                    {currentProduct.name}
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* 比較結果 */}
          {comparison && (
            <div className={`comparison-result ${comparison.isCurrentCheaper ? 'comparison-good' : 'comparison-bad'}`}>
              <h3 className="text-3xl font-bold mb-4">
                {comparison.isCurrentCheaper ? '🎉 お得です！' : '❌ いつものお店の方が安いです'}
              </h3>
              
              <div className="text-xl space-y-4">
                <p>
                  <strong>いつものお店 ({comparison.cheapestRegular.store}):</strong> 
                  {comparison.cheapestRegular.unitPrice.toFixed(2)}円/{currentTypeInfo.unit}
                  {comparison.cheapestRegular.name && (
                    <span style={{ color: '#64748b' }}> ({comparison.cheapestRegular.name})</span>
                  )}
                </p>
                <p>
                  <strong>今目の前の商品:</strong> 
                  {currentProduct.unitPrice.toFixed(2)}円/{currentTypeInfo.unit}
                  {currentProduct.name && (
                    <span style={{ color: '#64748b' }}> ({currentProduct.name})</span>
                  )}
                </p>
                
                <div className={`text-2xl font-bold ${comparison.isCurrentCheaper ? 'text-green' : 'text-red'}`}>
                  {comparison.isCurrentCheaper ? (
                    <p>
                      {Math.abs(comparison.savings).toFixed(2)}円/{currentTypeInfo.unit} 安い！
                      <br />
                      <span className="text-lg">({comparison.savingsPercent.toFixed(1)}% お得)</span>
                    </p>
                  ) : (
                    <p>
                      {Math.abs(comparison.savings).toFixed(2)}円/{currentTypeInfo.unit} 高い
                      <br />
                      <span className="text-lg">({comparison.savingsPercent.toFixed(1)}% 割高)</span>
                    </p>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* いつものお店の価格登録 */}
          <div className="card regular-prices">
            <h2 className="section-title text-blue">
              <Store size={24} />
              いつものお店の価格を登録・管理
            </h2>
            
            <div className="mb-4">
              <button
                onClick={addRegularPrice}
                className="btn btn-primary"
              >
                <Plus size={20} />
                新しい商品を追加
              </button>
            </div>

            <div className="space-y-4">
              {regularPrices.map(product => {
                const typeInfo = getProductTypeInfo(product.type);
                return (
                  <div key={product.id} className="card">
                    <div className="grid grid-cols-2 mb-2">
                      <select
                        value={product.type}
                        onChange={(e) => updateRegularPrice(product.id, 'type', e.target.value)}
                        className="input-field"
                      >
                        {productTypes.map(type => (
                          <option key={type.value} value={type.value}>{type.label}</option>
                        ))}
                      </select>
                      <input
                        type="text"
                        value={product.store}
                        onChange={(e) => updateRegularPrice(product.id, 'store', e.target.value)}
                        placeholder="店舗名"
                        className="input-field"
                      />
                    </div>
                    <div className="mb-2">
                      <input
                        type="text"
                        value={product.name}
                        onChange={(e) => updateRegularPrice(product.id, 'name', e.target.value)}
                        placeholder="商品名（任意）"
                        className="input-field"
                      />
                    </div>
                    <div className="grid grid-cols-3 mb-4">
                      <input
                        type="number"
                        value={product.quantity}
                        onChange={(e) => updateRegularPrice(product.id, 'quantity', e.target.value)}
                        placeholder={`${typeInfo.unit}数`}
                        className="input-field"
                        inputMode="decimal"
                      />
                      <input
                        type="number"
                        value={product.count}
                        onChange={(e) => updateRegularPrice(product.id, 'count', e.target.value)}
                        placeholder="個数"
                        className="input-field"
                        inputMode="decimal"
                      />
                      <input
                        type="number"
                        value={product.price}
                        onChange={(e) => updateRegularPrice(product.id, 'price', e.target.value)}
                        placeholder="価格"
                        className="input-field"
                        inputMode="decimal"
                      />
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <div>
                        <span className="font-semibold">
                          単価: {product.unitPrice > 0 ? `${product.unitPrice.toFixed(2)}円/${typeInfo.unit}` : '-'}
                        </span>
                        {product.name && (
                          <div className="mt-1" style={{ color: '#64748b' }}>
                            {product.name}
                          </div>
                        )}
                      </div>
                      <button
                        onClick={() => removeRegularPrice(product.id)}
                        className="btn btn-ghost"
                      >
                        <Trash2 size={18} />
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* 使い方の説明 */}
          {regularPrices.length === 0 && (
            <div className="help-text">
              <p className="text-lg mb-2">使い方:</p>
              <p>1. 下の「新しい商品を追加」でいつものお店の商品価格を登録</p>
              <p>2. 上の「今目の前の商品」で店頭の商品情報を入力</p>
              <p>3. どちらがお得か自動で比較結果が表示されます！</p>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<PriceComparisonTool />, document.getElementById('root'));
  </script>
</body>
</html>